name: dbt Data Quality Checks (CI)

on:
  # Triggers the workflow on push or pull request events to the main branch
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Defines a single job named 'test'
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' # Use a stable version of Python

      - name: Install dependencies
        run: |
          # Install dbt-duckdb and polars (required for your Python models)
          pip install dbt-duckdb polars

      - name: dbt Debug (Verify connection)
        # This step helps verify dbt can find the profile and adapter
        run: dbt debug --project-dir data_transformations

      - name: Install dbt dependencies
        # If you use dbt packages (like dbt_utils), this step is necessary
        run: dbt deps --project-dir data_transformations

      - name: Load CI Seed Data
        # IMPORTANT: Since you don't check in the full data set,
        # this step assumes a tiny, non-sensitive seed file (e.g., models/seeds/ci_test_data.csv)
        # exists in your repo for testing purposes. This file will be loaded into DuckDB.
        run: dbt seed --project-dir data_transformations --full-refresh

      - name: Run dbt Build (Runs models and tests)
        # Running 'dbt build' executes the models using the small seed data,
        # then runs all schema and data tests.
        run: dbt build --project-dir data_transformations

      - name: Check for Test Failures
        # If 'dbt build' fails (due to a test failure or model error), the job stops here.
        run: echo "dbt build completed successfully. All models transformed and tests passed."
